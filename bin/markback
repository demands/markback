#!/usr/bin/env coffee

fs = require "fs"
path = require "path"
Q = require "q"
Coffee = require "coffee-script"
Jsdom = require "jsdom"

compileMarkback = ->
  Q.nfcall(fs.readFile, path.join(__dirname, '../lib/markback.coffee')).then (coffeeSource) ->
    Q.fcall Coffee.compile, coffeeSource.toString 'utf-8'

getHtml = ->
  deferred = Q.defer()
  html = ''
  process.stdin.resume()
  process.stdin.setEncoding 'utf8'
  process.stdin.on 'data', (buf) -> html += buf.toString()
  process.stdin.on 'end', -> deferred.resolve html
  deferred.promise

Q.all([compileMarkback(), getHtml()])
  .spread (markback, html) -> 
    deferred = Q.defer()
    Jsdom.env {
      src: markback
      html
      done: deferred.makeNodeResolver()
    }
    deferred.promise
  .then (window) ->
    process.stdout.write window.Markback()
  .done
